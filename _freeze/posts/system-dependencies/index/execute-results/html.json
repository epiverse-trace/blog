{
  "hash": "d5f009c6a17e9de3220c53228a5ebfa9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"System Dependencies in R Packages & Automatic Testing\"\nauthor:\n  - name: \"Hugo Gruson\"\n    orcid: \"0000-0002-4094-1476\"\ndate: \"2023-09-26\"\ncategories: [package development, R, R package, continuous integration, system dependens]\nformat:\n  html: \n    toc: true\n---\n\n\n*This post has been [cross-posted on the R-hub blog](https://blog.r-hub.io/2023/09/26/system-dependency/), and the R-hub blog maintainers have contributed to the review and improvement of this post.*\n\nIn a [previous R-hub blog post](https://blog.r-hub.io/2022/09/12/r-dependency/), we discussed a package dependency that goes slightly beyond the normal R package ecosystem dependency: R itself.\nToday, we step even further and discuss dependencies outside of R: system dependencies.\nThis happens when packages rely on external software, such as how [R packages integrating CUDA GPU computation in R](https://github.com/search?q=org%3Acran+cuda+path%3ADESCRIPTION&type=code) require the [CUDA library](https://en.wikipedia.org/wiki/CUDA).\nIn particular, we are going to talk about system dependencies in the context of automated testing: is there anything extra to do when setting continuous integration for your package with system dependencies?\nIn particular, we will focus with the integration with [GitHub Actions](https://beamilz.com/posts/series-gha/2022-series-gha-1-what-is/en/).\nHow does it work behind the scenes?\nAnd how to work with edge cases?\n\n## Introduction: specifying system dependencies in R packages\n\nBefore jumping right into the topic of continuous integration, let's take a moment to introduce, or remind you, how system dependencies are specified in R packages.\n\nThe official 'Writing R Extensions' guide states [^1]:\n\n[^1]: For R history fans, this has been the case [since R 1.7.0](https://github.com/r-devel/r-svn/blob/9c46956fd784c6985867aca069b926d774602928/doc/NEWS.1#L2348-L2350), released in April 2003.\n\n> Dependencies external to the R system should be listed in the 'SystemRequirements' field, possibly amplified in a separate README file.\n\nThis was initially purely designed for humans.\nNo system within R itself makes use of it.\nOne important thing to note is that this field contains free text :scream:.\nAs such, to refer to the same piece of software, you could write either one of the following in the package `DESCRIPTION`:\n\n``` yaml\nSystemRequirements: ExternalSoftware\n```\n\n``` yaml\nSystemRequirements: ExternalSoftware 0.1\n```\n\n``` yaml\nSystemRequirements: lib-externalsoftware\n```\n\nHowever, it is probably good practice check what other R packages with similar system dependencies are writing in `SystemRequirements`, to facilitate the automated identification process we describe below.\n\n## The general case: everything works automagically\n\nIf while reading the previous section, you could already sense the problems linked to the fact `SystemRequirements` is a free-text field, fret not!\nIn the very large majority of cases, setting up continuous integration in an R package with system dependencies is exactly the same as with any other R package.\n\nUsing, as often, the supercharged usethis package, you can automatically create the relevant GitHub Actions workflow file in your project [^2]:\n\n[^2]: Alternatively, if you're not using usethis, you can manually copy-paste the relevant GitHub Actions workflow file from the [`examples` of the `r-lib/actions` project](https://github.com/r-lib/actions/tree/HEAD/examples).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nusethis::use_github_action(\"check-standard\")\n```\n:::\n\n\nThe result is:\n\n``` yaml\n# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples\n# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help\non:\n  push:\n    branches: [main, master]\n  pull_request:\n    branches: [main, master]\n\nname: R-CMD-check\n\njobs:\n  R-CMD-check:\n    runs-on: ${{ matrix.config.os }}\n\n    name: ${{ matrix.config.os }} (${{ matrix.config.r }})\n\n    strategy:\n      fail-fast: false\n      matrix:\n        config:\n          - {os: macos-latest,   r: 'release'}\n          - {os: windows-latest, r: 'release'}\n          - {os: ubuntu-latest,  r: 'devel', http-user-agent: 'release'}\n          - {os: ubuntu-latest,  r: 'release'}\n          - {os: ubuntu-latest,  r: 'oldrel-1'}\n\n    env:\n      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}\n      R_KEEP_PKG_SOURCE: yes\n\n    steps:\n      - uses: actions/checkout@v3\n\n      - uses: r-lib/actions/setup-pandoc@v2\n\n      - uses: r-lib/actions/setup-r@v2\n        with:\n          r-version: ${{ matrix.config.r }}\n          http-user-agent: ${{ matrix.config.http-user-agent }}\n          use-public-rspm: true\n\n      - uses: r-lib/actions/setup-r-dependencies@v2\n        with:\n          extra-packages: any::rcmdcheck\n          needs: check\n\n      - uses: r-lib/actions/check-r-package@v2\n        with:\n          upload-snapshots: true\n```\n\nYou may notice there is no explicit mention of system dependencies in this file.\nYet, if we use this workflow in an R package with system dependencies, everything will work out-of-the-box in most cases.\nSo, when are system dependencies installed?\nAnd how the workflow does even know which dependencies to install since the `SystemRequirements` is free text that may not correspond to the exact name of a library?\n\nThe magic happens in the `r-lib/actions/setup-r-dependencies` step.\nIf you want to learn about it, you can read the [source code of this step](https://github.com/r-lib/actions/blob/756399d909bf9c180bbdafe8025f794f51f2da02/setup-r-dependencies/action.yaml).\nIt is mostly written in R but it contains a lot of bells and whistles to handle messaging within the GitHub Actions context and as such, it would be too long to go through it line by line in this post.\nHowever, at a glance, you can notice many mentions of the [pak R package](https://pak.r-lib.org/).\n\nIf it's the first time you're hearing about the pak package, we strongly recommend we go through the [list of the most important pak features](https://pak.r-lib.org/reference/features.html).\nIt is ~~paked~~ packed with many very powerful features.\nThe specific feature we're interested in here is the automatic install of system dependencies via [`pak::pkg_sysreqs()`](https://pak.r-lib.org/reference/local_system_requirements.html), which in turn uses `pkgdepends::sysreqs_install_plan()`.\n\nWe now understand more precisely where the magic happens but it still doesn't explain how pak is able to know which precise piece of software to install from the free text `SystemRequirements` field.\nAs often when you want to increase your understanding, it is helpful to [read the source](https://blog.r-hub.io/2019/05/14/read-the-source/).\nWhile browsing pkgdepends source code, we see a call to <https://github.com/r-hub/r-system-requirements>.\n\nThis repository contains a set of [rules](https://github.com/rstudio/r-system-requirements/tree/main/rules) as json files which match unformatted software name via regular expressions to the exact libraries for each major operating system.\nLet's walk through an example together:\n\n``` json\n{\n  \"patterns\": [\"\\\\bnvcc\\\\b\", \"\\\\bcuda\\\\b\"],\n  \"dependencies\": [\n    {\n      \"packages\": [\"nvidia-cuda-dev\"],\n      \"constraints\": [\n        {\n          \"os\": \"linux\",\n          \"distribution\": \"ubuntu\"\n        }\n      ]\n    }\n  ]\n}\n```\n\nThe regular expression tells that each time a package lists something as `SystemRequirements` with the word \"nvcc\" or \"cuda\", the corresponding Ubuntu library to install is `nvidia-cuda-dev`.\n\nThis interaction between `r-system-requirements` and pak is also documented in pak's dev version, with extra information about how the `SystemRequirements` field is extracted in different situations: <https://pak.r-lib.org/dev/reference/sysreqs.html#how-it-works>\n\n## When it's not working out-of-the-box\n\nWe are now realizing that this automagical setup we didn't pay so much attention to until now actually requires a very heavy machinery under the hood.\nAnd it happens, very rarely, that this complex machinery is not able to handle your specific use case.\nBut it doesn't mean that you cannot use continuous integration in your package.\nIt means that some extra steps might be required to do so.\nLet's review these possible solutions together in order of complexity.\n\n### Fix it for everybody by submitting a pull request\n\nOne first option might be that the regular expression used by `r-system-requirements` to convert the free text in `SystemRequirements` to a library distributed by your operating system does not recognize what is in `SystemRequirements`.\n\nTo identify if this is the case, you need to find the file containing the specific rule for the system dependency of interest in `r-system-requirements`, and test the regular expression on the contents of `SystemRequirements`.\n\nIf we re-use the cuda example from the previous section and we are wondering why it is not automatically installed for a package specifying \"cudaa\":\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstringr::str_match(\"cudaa\", c(\"\\\\bnvcc\\\\b\", \"\\\\bcuda\\\\b\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     [,1]\n[1,] NA  \n[2,] NA  \n```\n\n\n:::\n:::\n\n\nThis test confirms that the `SystemRequirements` field contents are not recognized by the regular expression.\nDepending on the case, the best course of action might be to:\n\n- either edit the contents of `SystemRequirements` so that it's picked up by the regular expression\n- or submit a pull request to [`rstudio/r-system-requirements`](https://github.com/rstudio/r-system-requirements) [^3] if you believe the regular expression is too restrictive and should be updated ([example](https://github.com/rstudio/r-system-requirements/pull/93))\n\n[^3]: If you are wondering why we are saying to submit PR to `rstudio/r-system-requirements` when we were previously talking about `r-hub/r-system-requirements`, you can check out [this comment thread](https://github.com/r-hub/blog/pull/165#discussion_r1280644182).\n\nNote however that the first option is likely always the simplest as it doesn't impact all the rest of the ecosystem (which is why `r-system-requirements` maintainers might be reluctant to relax a regular expression) and it is often something directly in your control, rather than a third-party who might not immediately be available to review your PR.\n\n### Install system dependencies \"manually\"\n\nHowever, you might be in a case where you cannot rely on the automated approach.\nFor example, maybe the system dependency to install is not provided by package managers at all.\nTypically, if you had to compile or install it manually on your local computer, you're very likely to have to do the same operation in GitHub Actions.\nThere two different, but somewhat equivalent, ways to do so, as detailed below.\n\n#### Directly in the GitHub Actions workflow\n\nYou can insert the installation steps you used locally in the GitHub Actions workflow file.\nSo, instead of having the usual structure, you have an extra step \"Install extra system dependencies manually\" that may look something like this:\n\n``` diff\njobs:\n  R-CMD-check:\n    runs-on: ubuntu-latest\n    env:\n      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}\n      R_KEEP_PKG_SOURCE: yes\n    steps:\n      - uses: actions/checkout@v3\n\n      - uses: r-lib/actions/setup-r@v2\n        with:\n          use-public-rspm: true\n\n+      - name: Install extra system dependencies manually\n+        run:\n+          wget ...\n+          make\n+          sudo make install\n\n      - uses: r-lib/actions/setup-r-dependencies@v2\n        with:\n          extra-packages: any::rcmdcheck\n          needs: check\n\n      - uses: r-lib/actions/check-r-package@v2\n```\n\nYou can see [a real-life example in the rbi R package](https://github.com/sbfnk/rbi/blob/9b05a24ce42f7b1b53481370f3bde3dcd86bca02/.github/workflows/R-CMD-check.yaml).\n\n#### Using a Docker image in GitHub Actions\n\nAlternatively, you can do the manual installation in a Docker image and use this image in your GitHub Actions workflow.\nThis is a particularly good solution if there is already a public Docker image or you already wrote a `DOCKERFILE` for your own local development purposes.\nIf you use a public image, you can follow [the steps in the official documentation](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#example-running-a-job-within-a-container) to integrate it to your GitHub Actions job.\nIf you use a `DOCKERFILE`, you can follow [the answers to this stackoverflow question](https://stackoverflow.com/q/61154750/4439357) (in a nutshell, use `docker compose` in your job or publish the image first and then follow the official documentation).\n\n``` diff\njobs:\n  R-CMD-check:\n    runs-on: ubuntu-latest\n+    container: ghcr.io/org/repo:main\n    env:\n      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}\n      R_KEEP_PKG_SOURCE: yes\n    steps:\n      - uses: actions/checkout@v3\n\n      - uses: r-lib/actions/setup-r@v2\n        with:\n          use-public-rspm: true\n\n      - uses: r-lib/actions/setup-r-dependencies@v2\n        with:\n          extra-packages: any::rcmdcheck\n          needs: check\n\n      - uses: r-lib/actions/check-r-package@v2\n```\n\nYou can again see [a real-life example in the rbi R package](https://github.com/sbfnk/rbi/pull/46/files).\n\n## Conclusion\n\nIn this post, we have provided an overview of how to specify system requirements for R package, how this seemingly innocent task requires a very complex infrastructure so that it can be understood by automated tools and that your dependencies are smoothly installed in a single command.\nWe also gave some pointers on what to do if you're in one of the rare cases where the automated tools don't or can't work.\n\nOne final note on this topic is that there might be a move from CRAN to start requiring more standardization in the `SystemRequirements` field.\nOne R package developer has reported being asked to change \"Java JRE 8 or higher\" to \"Java (\\>= 8)\".\n\n*Many thanks to [Maëlle Salmon](https://masalmon.eu/) & [Gábor Csárdi](https://github.com/gaborcsardi) for their insights into this topic and their valuable feedback on this post.*\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}