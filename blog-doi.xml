<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Epiverse-TRACE developer space</title>
<link>https://epiverse-trace.github.io/blog.html#category=DOI</link>
<atom:link href="https://epiverse-trace.github.io/blog-doi.xml" rel="self" type="application/rss+xml"/>
<description>A place for Epiverse-TRACE developers to share their reflections, learnings, and showcase their work.</description>
<generator>quarto-1.6.1</generator>
<lastBuildDate>Wed, 26 Jun 2024 00:00:00 GMT</lastBuildDate>
<item>
  <title>Choosing the Right Parent for R Object Classes</title>
  <dc:creator>Hugo Gruson</dc:creator>
  <link>https://epiverse-trace.github.io/posts/parent-class/</link>
  <description><![CDATA[ 





<p><a href="https://hugogruson.fr/posts/compa-tibble/">I have recently published</a> a <a href="https://epiverse-trace.github.io/posts/s3-generic/">series of blog posts</a> on the reasons why one may want to start using object-oriented programming (and more specifically R S3 classes) to improve interoperability with other tools from the ecosystem.</p>
<p>But there are still questions I have not addressed directly, even if they may have been implicitly included sometimes: what makes a good object class? What good practices in class &amp; function design can improve interoperability?</p>
<p>As you can expect from these questions, this post will present a subjective view on S3 class and method design. I will argue that it is often a good strategy to inherit from existing standards classes, and to leverage this inheritance relationship as much as possible.</p>
<section id="inherit-from-standard-classes" class="level2">
<h2 class="anchored" data-anchor-id="inherit-from-standard-classes">Inherit from standard classes</h2>
<p>A unique feature of R is the availability and centrality of <code>data.frame</code>s in the base language, whereas you need extra libraries for a similar functionality in most other languages (e.g., <a href="https://pandas.pydata.org/">pandas</a> in Python).</p>
<p><code>data.frame</code> is one of the first “complex” (in the sense of <a href="https://adv-r.hadley.nz/vectors-chap.html#atomic-vectors">non-atomic</a>) object most R learners will be exposed to and will develop a familiarity with. A good way to leverage this familiarity is to <a href="https://epiverse-trace.github.io/posts/extend-dataframes/">make your subclass a thin wrapper around <code>data.frame</code>s</a>.</p>
<p>This means that not only will users be able to get started with your package faster because of this familiarity, but you will also immediately benefit from the huge ecosystem of functions and packages working on <code>data.frame</code>s, such as the <a href="https://tidyverse.org">tidyverse</a>. If you want some examples, this is what collaborators and I did in the <a href="https://github.com/epiverse-trace/linelist">linelist</a>, <a href="https://github.com/rmaia/pavo">pavo</a>, <a href="https://github.com/epiforecasts/scoringutils">scoringutils</a>, <a href="https://github.com/epiverse-trace/epichains">epichains</a>, and <a href="https://github.com/epiverse-trace/vaccineff">vaccineff</a> R packages.</p>
<p>In some cases, the output is too complex to fit into a <code>data.frame</code>. Even in this situation, I would recommend inheriting from existing, well-established, classes for the same two reasons: familiarity and ecosystem. For example, for the <a href="https://github.com/epiverse-trace/serofoi">serofoi</a> R package, <a href="https://github.com/epiverse-trace/serofoi/pull/117">we have made the decision to inherit from <code>stanfit</code> objects, rather than a custom structure</a>.</p>
</section>
<section id="rely-on-parent-methods-as-much-as-possible" class="level2">
<h2 class="anchored" data-anchor-id="rely-on-parent-methods-as-much-as-possible">Rely on parent methods as much as possible</h2>
<p>A follow up recommendation from inheriting from standard classes is to leverage their methods wherever possible.</p>
<p><a href="https://github.com/epiverse-trace/linelist/pull/60">One of the first</a> <a href="https://github.com/epiverse-trace/linelist/pull/61">changes I made</a> when becoming maintainer of the <a href="https://github.com/epiverse-trace/linelist">linelist</a> package was to remove the <code>rename.linelist()</code> and <code>select.linelist()</code> methods. Indeed, they were, or could easily be, behaving identically as the parent <code>rename.data.frame()</code> and <code>select.data.frame()</code> methods. Rather than burdening the codebase and maintenance with an extra unnecessary method, it is much simpler and more robust to rely on the well-tested parent method. In fact, the <a href="https://dplyr.tidyverse.org/reference/dplyr_extending.html">dplyr documentation</a> explicitly recommends only writing methods for a couple of standard functions (including <code>[.subclass()</code> and <code>names&lt;-.subclass()</code>), which will enable the use of parent methods directly, rather than writing custom methods for each dplyr function.</p>
<p>Similarly, many developers have the reflex to write a custom <code>print.subclass()</code> method as part of the method implementation. While it may be justified in some cases, it is sometimes unnecessary. My recommendation would be to evaluate carefully what benefits the custom method brings over the default parent method.</p>
</section>
<section id="enable-conversion-to-standard-classes" class="level2">
<h2 class="anchored" data-anchor-id="enable-conversion-to-standard-classes">Enable conversion to standard classes</h2>
<p>If after careful consideration, extra metadata makes it too difficult to fit your new class into an existing class, you may sometimes have to define your own class from “scratch” (i.e., often <code>list()</code> in R).</p>
<p>But even in this case, you can still apply some of the ideas proposed earlier. As much as possible, you should provide helpers or methods to enable the streamlined conversion of your method to a standard class.</p>
<p>A good example here is the <a href="https://github.com/epiverse-trace/epiparameter">epiparameter</a> package, which provides a complex S3 class built on lists, including extensive metadata about probability distribution of epidemiological parameters. As such, this custom class cannot be used out of the box in most functions from other packages. <a href="https://github.com/epiverse-trace/epiparameter/blob/0f805b90f984def4851a78148f1cf44c3d480845/R/coercion.R#L18-L41">But an <code>as.function()</code> method is conveniently provided to enable the conversion of this probability distribution parameters into a density distribution</a>, which can then be used in functions which expect a <code>function</code> object.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In summary, I recommend relying on well-established parent classes such as <code>data.frame</code>s or at least providing direct conversion functions to these standard classes, and using parent methods wherever possible rather than writing custom dedicated methods. This should help produce a package:</p>
<ul>
<li>more easily accessible for users because it uses objects that feel familiar</li>
<li>more maintainable because a lot of method writing is offloaded to the parent class</li>
<li>more likely to be interoperable because standard classes are a good way to pass data between functions or packages</li>
</ul>
<p><strong>Thanks to Chris Hartgerink, James Azam and Josh Lambert, for their very valuable feedback on this post.</strong></p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{gruson2024,
  author = {Gruson, Hugo},
  title = {Choosing the {Right} {Parent} for {R} {Object} {Classes}},
  date = {2024-06-26},
  url = {https://epiverse-trace.github.io/posts/parent-class/},
  doi = {10.59350/fk6nv-1k973},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-gruson2024" class="csl-entry quarto-appendix-citeas">
Gruson, Hugo. 2024. <span>“Choosing the Right Parent for R Object
Classes.”</span> June 26, 2024. <a href="https://doi.org/10.59350/fk6nv-1k973">https://doi.org/10.59350/fk6nv-1k973</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <category>R package</category>
  <category>object-oriented programming</category>
  <category>S3</category>
  <category>interoperability</category>
  <category>DOI</category>
  <guid>https://epiverse-trace.github.io/posts/parent-class/</guid>
  <pubDate>Wed, 26 Jun 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Things that can go wrong when using renv</title>
  <dc:creator>Hugo Gruson</dc:creator>
  <link>https://epiverse-trace.github.io/posts/renv-complications/</link>
  <description><![CDATA[ 





<p>Throughout the Epiverse project, we use the <a href="https://rstudio.github.io/renv/">renv R package</a> to ensure reproducibility of the training materials and the pipelines we are providing. But we sometimes get reports from users who struggle to rebuild the environment and run the code.</p>
<p>In this post, we dissect the source of these issues, explain why in reality renv is not at fault, and how this is caused by the inherent complexity of reproducibility. The renv documentation already includes <a href="https://rstudio.github.io/renv/articles/renv.html#caveats">caveats</a> explaining why some situations are bound to require more complex tools. This blog post reiterates some of these caveats and illustrates them with concrete examples.</p>
<p>Finally, we mention a couple of more complete (but more complex!) frameworks that can overcome the issues presented here. We do not explore these alternative framework in detail but provide links to more information.</p>
<section id="binaries-vs-building-from-source" class="level2">
<h2 class="anchored" data-anchor-id="binaries-vs-building-from-source">Binaries vs building from source</h2>
<p>Software, including R packages, can generally be delivered in two forms: as binaries or as source code. If you are building from the source code, you may in some case need a compilation toolchain on your computer. If that toolchain is missing, it can lead to errors such as:</p>
<blockquote class="blockquote">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb1-1">ld: warning: search path '/opt/gfortran/lib' not found</span>
<span id="cb1-2">ld: library 'gfortran' not found</span></code></pre></div>
</blockquote>
<p>Most of the time, regular users of R will not see these errors because they are installing binaries. Indeed, CRAN provides pre-compiled binaries for Windows and macOS for the last version of the package and R.</p>
<p>With renv, you often want to install older versions of the packages, which won’t be available as binaries from CRAN. This means you are more likely to have to compile the package yourself and see this kind of errors, even though renv is not causing them.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
gfortran issues on Apple Silicon computers
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you are an Apple Silicon (Mac M1, M2, M3) user and encounter issues with gfortran, we have had success using the <a href="https://github.com/coatless-mac/macrtools/">macrtools R package</a> and we strongly recommend checking it out.</p>
</div>
</div>
</section>
<section id="beyond-renv-scope-incompatibility-with-system-dependency-versions" class="level2">
<h2 class="anchored" data-anchor-id="beyond-renv-scope-incompatibility-with-system-dependency-versions">Beyond renv scope: incompatibility with system dependency versions</h2>
<p>We <a href="../system-dependencies/">discussed previously the topic of system dependencies</a>, and <a href="https://blog.r-hub.io/2022/09/12/r-dependency/">dependencies on specific R versions</a>. These special dependencies can also be a source of headaches when using renv.</p>
<p>The heart of the issue is that renv provides a simplified solution to reproducibility: it focuses on R packages and their versions. But other sources of non-reproducibility are outside its scope. In many cases, this will not be a problem, as the main source of non-reproducibility, especially in the relatively short-term, will be R package versions.</p>
<p>But sometimes, it is possible that the <code>renv.lock</code> lockfile requires such an old version of an R package that it was written with a syntax that is no longer supported by recent R versions or modern compilers.</p>
<p>For example, a recent project (from 2023) was trying to install the version 0.60.1 of the <code>matrixStats</code> package (from 2021). This lead to this compilation error:</p>
<blockquote class="blockquote">
<p>error: ‘DOUBLE_XMAX’ undeclared (first use in this function); did you mean ‘DBL_MAX’?</p>
</blockquote>
<!-- markdownlint-disable MD033 -->
<details>
<summary>
Click to see the full error message
</summary>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb2-1">! Error installing package 'matrixStats':</span>
<span id="cb2-2">=======================================</span>
<span id="cb2-3"></span>
<span id="cb2-4">* installing *source* package ‘matrixStats’ ...</span>
<span id="cb2-5">** package ‘matrixStats’ successfully unpacked and MD5 sums checked</span>
<span id="cb2-6">** using staged installation</span>
<span id="cb2-7">** libs</span>
<span id="cb2-8">using C compiler: ‘gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0’</span>
<span id="cb2-9">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c 000.init.c -o 000.init.o</span>
<span id="cb2-10">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c allocMatrix2.c -o allocMatrix2.o</span>
<span id="cb2-11">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c anyMissing.c -o anyMissing.o</span>
<span id="cb2-12">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c binCounts.c -o binCounts.o</span>
<span id="cb2-13">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c binMeans.c -o binMeans.o</span>
<span id="cb2-14">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c colCounts.c -o colCounts.o</span>
<span id="cb2-15">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c colOrderStats.c -o colOrderStats.o</span>
<span id="cb2-16">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c colRanges.c -o colRanges.o</span>
<span id="cb2-17">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c diff2.c -o diff2.o</span>
<span id="cb2-18">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c indexByRow.c -o indexByRow.o</span>
<span id="cb2-19">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c logSumExp.c -o logSumExp.o</span>
<span id="cb2-20">gcc -I"/usr/share/R/include" -DNDEBUG       -fpic  -g -O2 -ffile-prefix-map=/build/r-base-H0vbME/r-base-4.3.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c mean2.c -o mean2.o</span>
<span id="cb2-21">In file included from mean2_lowlevel.h:14,</span>
<span id="cb2-22">                 from mean2.c:9:</span>
<span id="cb2-23">mean2_lowlevel_template.h: In function ‘mean2_int’:</span>
<span id="cb2-24">mean2_lowlevel_template.h:59:13: error: ‘DOUBLE_XMAX’ undeclared (first use in this function); did you mean ‘DBL_MAX’?</span>
<span id="cb2-25">   59 |   if (sum &gt; DOUBLE_XMAX) {</span>
<span id="cb2-26">      |             ^~~~~~~~~~~</span>
<span id="cb2-27">      |             DBL_MAX</span>
<span id="cb2-28">mean2_lowlevel_template.h:59:13: note: each undeclared identifier is reported only once for each function it appears in</span>
<span id="cb2-29">In file included from mean2_lowlevel.h:18,</span>
<span id="cb2-30">                 from mean2.c:9:</span>
<span id="cb2-31">mean2_lowlevel_template.h: In function ‘mean2_dbl’:</span>
<span id="cb2-32">mean2_lowlevel_template.h:59:13: error: ‘DOUBLE_XMAX’ undeclared (first use in this function); did you mean ‘DBL_MAX’?</span>
<span id="cb2-33">   59 |   if (sum &gt; DOUBLE_XMAX) {</span>
<span id="cb2-34">      |             ^~~~~~~~~~~</span>
<span id="cb2-35">      |             DBL_MAX</span>
<span id="cb2-36">make: *** [/usr/lib/R/etc/Makeconf:191: mean2.o] Error 1</span>
<span id="cb2-37">ERROR: compilation failed for package ‘matrixStats’</span></code></pre></div>
</details>
<p>The explanation for this error can be found in <a href="https://github.com/HenrikBengtsson/matrixStats/blob/799669fc6de6f55a74cab06cc6a97634aa24ab0e/NEWS.md?plain=1#L111-L113">the <code>matrixStats</code> release notes</a>, specifically the section for matrixStats 0.63.0:</p>
<blockquote class="blockquote">
<ul>
<li>Updated native code to use the C99 constant <code>DBL_MAX</code> instead of legacy S constant <code>DOUBLE_XMAX</code>, which is planned to be unsupported in R (&gt;= 4.2.0).</li>
</ul>
</blockquote>
</section>
<section id="some-solutions" class="level2">
<h2 class="anchored" data-anchor-id="some-solutions">Some solutions</h2>
<section id="alternative-package-managers" class="level3">
<h3 class="anchored" data-anchor-id="alternative-package-managers">Alternative package managers</h3>
<p>We discussed how many issues when using renv can arise during the package compilation from source. A potential solution would be to avoid this compilation step and always install pre-compiled binaries.</p>
<p>This is not possible while installing from CRAN as CRAN only provides binaries for recent versions of R and for a limited number of platforms.</p>
<p>But Posit for example provides a larger collection of binaries, for different package versions, and different platforms, via their Public <a href="https://packagemanager.posit.co/">Posit Package Manager (PPM)</a>.</p>
<p>Making sure you install from PPM rather than CRAN can be a first simple step to make some of the issues discussed here vanish.</p>
</section>
<section id="extending-the-scope-of-reproducibility" class="level3">
<h3 class="anchored" data-anchor-id="extending-the-scope-of-reproducibility">Extending the scope of reproducibility</h3>
<p>Another solution could be to add more complex reproducibility solutions that go beyond the scope of renv.</p>
<section id="renv-with-rig" class="level4">
<h4 class="anchored" data-anchor-id="renv-with-rig">renv with rig</h4>
<p>The R version is specified in <code>renv.lock</code> and to avoid incompatibility of older package versions with newer versions of R, you could run the declared R version. This can be achieved with various means but a convenient solution is the <a href="https://github.com/r-lib/rig">rig</a> tool.</p>
<p>There are even some <a href="https://github.com/r-lib/rig/issues/131">discussions</a> to integrate rig and renv more tightly and let rig detect automatically which R version to use based on the <code>renv.lock</code> file.</p>
</section>
<section id="docker-nix-and-others" class="level4">
<h4 class="anchored" data-anchor-id="docker-nix-and-others">Docker, Nix and others</h4>
<p>Alternatively, you could use other reproducibility toolkits that focus not just on the R package versions, but on the entire software stack (e.g., including the operating system, the system dependencies). These solutions can be more complex to set up and use, and we won’t detail them in this blog post but you can find more information in:</p>
<ul>
<li><a href="https://rstudio.github.io/renv/articles/docker.html">The “Using renv with Docker” renv vignette</a></li>
<li><a href="https://doi.org/10.32614/RJ-2017-065">the “An Introduction to Rocker: Docker Containers for R” paper</a></li>
<li><a href="https://www.brodrigues.co/blog/2023-07-13-nix_for_r_part1/">Bruno Rodrigues’ entire series of blog posts on Nix</a></li>
</ul>
</section>
</section>
<section id="conclusion-a-final-note-for-developers" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-a-final-note-for-developers">Conclusion: a final note for developers</h3>
<p>renv is an elegant solution that focuses on the most immediate source of non-reproducibility. This however means it needs to be complemented by other tools in more complex cases.</p>
<p>Ultimately, reproducibility is a team effort. People who write code can minimise the risk of renv complications by keeping the packages they use close to their CRAN version and regularly updating their code and <code>renv.lock</code> accordingly. Other programming languages have automated tooling to help with this, via, e.g., the <a href="https://github.blog/2020-06-01-keep-all-your-packages-up-to-date-with-dependabot/">dependabot tool</a> which submits pull requests to update dependencies. There is no well established equivalent for R yet, but anyone willing to set this mechanism up can look at the code used by the <a href="https://github.com/carpentries/actions/tree/70ff4b4e8d50fdcd0eb33e7c33a4a6f305a82702/update-lockfile">Carpentries workbench</a> for this task.</p>
<p><em>Thanks to Pratik Gupte and Chris Hartgerink for their valuable comments on earlier drafts of this post.</em></p>


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{gruson2024,
  author = {Gruson, Hugo},
  title = {Things That Can Go Wrong When Using Renv},
  date = {2024-01-31},
  url = {https://epiverse-trace.github.io/posts/renv-complications/},
  doi = {10.59350/hsy4m-6se90},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-gruson2024" class="csl-entry quarto-appendix-citeas">
Gruson, Hugo. 2024. <span>“Things That Can Go Wrong When Using
Renv.”</span> January 31, 2024. <a href="https://doi.org/10.59350/hsy4m-6se90">https://doi.org/10.59350/hsy4m-6se90</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <category>reproducibility</category>
  <category>renv</category>
  <category>DOI</category>
  <guid>https://epiverse-trace.github.io/posts/renv-complications/</guid>
  <pubDate>Wed, 31 Jan 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>2024 mpox outbreak: common analytics tasks and available R tools</title>
  <dc:creator>James Azam</dc:creator>
  <dc:creator>Hugo Gruson</dc:creator>
  <dc:creator>Adam Kucharski</dc:creator>
  <link>https://epiverse-trace.github.io/posts/mpox-preparedness/</link>
  <description><![CDATA[ 





<p>There are ongoing outbreaks of mpox globally. The Democratic Republic of Congo (DRC) is so far the worst hit with a total of 7,851 cases and 384 deaths reported between January 1 and May 26, 2024 <sup>1</sup>. Before 2022, there were few reports of sustained mpox transmission globally. However, during the following year (Jan 1, 2022, and Jan 29, 2023), 110 countries in all six WHO Regions had reported a total of 85,473 confirmed cases and 89 deaths between them <span class="citation" data-cites="laurenson2023description">(Laurenson-Schafer et al. 2023)</span>.</p>
<p>Mpox is transmitted through respiratory droplets and direct contact with infected persons. The disease is characterized by fever, cough, and a rash, with the mean incubation period estimated to be about 7.8 days <span class="citation" data-cites="ward2022transmission">(Ward et al. 2022)</span>. Infected individuals may experience severe symptoms leading to hospitalisation or death. There are two genetic clades: clade I and clade II, which also has subclades IIa and IIb <span class="citation" data-cites="laurenson2023description">(Laurenson-Schafer et al. 2023)</span>.</p>
<p>Several analyses of the potential impact of outbreaks at country level have already emerged in 2024. The US CDC, for example, has analysed the potential size of outbreaks resulting from transmission within and between households <sup>2</sup> and the risk of Clade 1 mpox outbreaks among some key populations associated with key transmission routes <sup>3</sup>. Another group of researchers have estimated the transmissibility of mpox in the DRC from more recent (2010 - 2019) surveillance data to update existing estimates, which are based on old data <span class="citation" data-cites="charniga2024updating">(Charniga, McCollum, et al. 2024)</span>. However, tackling ongoing outbreaks around the world will require a coordinated response from the global health community.</p>
<p>The Epiverse-TRACE team is developing a set of analytical tools that could help support decision-makers during outbreaks. This post provides an overview of the tasks that such tools can be applied to in the context of the ongoing mpox outbreaks.</p>
<section id="common-outbreak-analytics-tasks" class="level2">
<h2 class="anchored" data-anchor-id="common-outbreak-analytics-tasks">Common outbreak analytics tasks</h2>
<p>Outbreak analytics in the context of the ongoing mpox outbreak involves several tasks that can be handled by existing and emerging R tools. Some of the tasks include estimating the transmission potential, forecasting infection dynamics, estimating severity, and assessing the impact of interventions.</p>
<p>Here, we briefly describe some common tasks, data required, and the ready R tools/packages developed by the Epiverse-TRACE team and the wider community.</p>
<section id="cleaning-and-validating-data" class="level3">
<h3 class="anchored" data-anchor-id="cleaning-and-validating-data">Cleaning and validating data</h3>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>Data cleaning is often the first task in outbreak analytics. This usually involves identifying and correcting errors in the data, standardizing the format of key variables, and ensuring that the data is in a format that is fit for analysis. Data validation is also important to ensure that the data is accurate.</p>
</div>
</div>
</div>
<p><a href="https://epiverse-trace.github.io/cleanepi/"><code>{cleanepi}</code></a> is useful for cleaning individual-level datasets, and <a href="https://epiverse-trace.github.io/linelist/"><code>{listlist}</code></a> can be used to tag and validate key variables in datasets that might change over time. The <a href="https://epiverse-trace.github.io/numberize/"><code>{numberize}</code></a> package can also be used to convert numbers written as text. It currently has functionality for English, Spanish, and French.</p>
</section>
<section id="estimating-transmission-potential" class="level3">
<h3 class="anchored" data-anchor-id="estimating-transmission-potential">Estimating transmission potential</h3>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>A key initial question during emerging outbreaks is the transmission potential of the disease. This is typically quantified using parameters such as: the basic reproduction number, <img src="https://latex.codecogs.com/png.latex?R_0">; the time-varying reproduction number, <img src="https://latex.codecogs.com/png.latex?R_t">; and <img src="https://latex.codecogs.com/png.latex?k">, which captures individual heterogeneity in transmission (i.e.&nbsp;“superspreading” potential). These quantities are useful to assess the potential for further spread of the disease and the impact of interventions.</p>
</div>
</div>
</div>
<section id="population-level-transmissibility-r_0-and-r_t" class="level4">
<h4 class="anchored" data-anchor-id="population-level-transmissibility-r_0-and-r_t">Population-level transmissibility (<img src="https://latex.codecogs.com/png.latex?R_0"> and <img src="https://latex.codecogs.com/png.latex?R_t">)</h4>
<p>The basic reproduction number, <img src="https://latex.codecogs.com/png.latex?R_0">, is the average number of secondary cases produced by a single infected individual in a completely susceptible population. The time-varying reproduction number, <img src="https://latex.codecogs.com/png.latex?R_t">, on the other hand, is the average number of secondary cases produced by a single infected individual at time <img src="https://latex.codecogs.com/png.latex?t"> in a partially susceptible population. <img src="https://latex.codecogs.com/png.latex?R_t"> is a more useful quantity during an outbreak as it accounts for the impact of interventions and changes in population immunity.</p>
<p>If data is available on the daily number of reported cases, <a href="https://epiforecasts.io/EpiNow2/"><code>{EpiNow2}</code></a> and <a href="https://mrc-ide.github.io/EpiEstim/"><code>{EpiEstim}</code></a> can be used to estimate <img src="https://latex.codecogs.com/png.latex?R_t">. These packages require data on the time scale of transmission (i.e.&nbsp;the generation time, or the serial interval, which is <a href="https://royalsocietypublishing.org/doi/10.1098/rsif.2020.0756">commonly used as a proxy</a> for this). While <code>{EpiEstim}</code> focuses on retrospective estimation of <img src="https://latex.codecogs.com/png.latex?R_t">, <code>{EpiNow2}</code> is designed for both retrospective and real-time estimation.</p>
<p>In estimating <img src="https://latex.codecogs.com/png.latex?R_t">, one practical consideration is the impact of various delays (biological and reporting) on the estimates <span class="citation" data-cites="charniga2024best park2024estimating gostic2020practical">(Charniga, Park, et al. 2024; Park et al. 2024; Katelyn M. Gostic 2020)</span>. <code>{EpiNow2}</code> adjusts for these delays in various ways. For example, it accounts for the symptom onset and reporting delays by taking the incubation period and reporting delay as inputs. Moreover, <code>{EpiNow2}</code> can estimate the reporting delay from the data if data on incidence by date of onset and report are available.</p>
<p>Furthermore, dedicated packages have emerged for estimating epidemiological delays from data using best practices. <a href="https://epidist.epinowcast.org/articles/epidist.html"><code>{epidist}</code></a> offers the ability to estimate delay distributions, accounting for issues such as truncation (i.e., not all disease outcomes will yet be known in real-time).</p>
<p>If delay data are not available, published estimates of the incubation period and serial interval can be used. The <a href="https://epiverse-trace.github.io/epiparameter/"><code>{epiparameter}</code></a> package collates a database of epidemiological distributions from the literature and provides functions for interacting with the database. You can view the <a href="https://epiverse-trace.github.io/epiparameter/dev/articles/database">database</a> for currently available parameters (more entries are planned). Additionally, if only summary statistics are available (e.g.&nbsp;range and median), <code>{epiparameter}</code> can be used to extract the distribution parameters.</p>
</section>
<section id="individual-level-transmissibility-superspreading" class="level4">
<h4 class="anchored" data-anchor-id="individual-level-transmissibility-superspreading">Individual-level transmissibility (superspreading)</h4>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>The individual-level transmission heterogeneity (superspreading), often denoted as <img src="https://latex.codecogs.com/png.latex?k">, is an important measure for tailoring interventions at the individual level.</p>
</div>
</div>
</div>
<p>If we have data on the distribution of sizes of transmission clusters, the <a href="https://epiverse-trace.github.io/epichains/"><code>{epichains}</code></a> package provides functions to set up the likelihood function to estimate <img src="https://latex.codecogs.com/png.latex?R_0"> and <img src="https://latex.codecogs.com/png.latex?k">. The user inputs the negative binomial offspring, which assumes individuals exhibit heterogeneity in transmission. The parameters of the negative offspring distribution can then be estimated using existing maximum likelihood or bayesian frameworks.</p>
<p>Furthermore, if we have individual-level transmission chain data, the <a href="https://epiverse-trace.github.io/superspreading/"><code>{superspreading}</code></a> package can be used to estimate <img src="https://latex.codecogs.com/png.latex?R_0"> and <img src="https://latex.codecogs.com/png.latex?k"> from the offspring distribution. This package also provides functions to estimate the probability that an outbreak will not go extinct in its early stages because of randomness in transmission (e.g.&nbsp;if the primary spillover case(s) does not infect others).</p>
<p>If we have data on sexual contacts and the secondary attack rate, then we can also use <code>{superspreading}</code> to <a href="https://epiverse-trace.github.io/superspreading/articles/heterogeneous_network_outbreaks.html">calculate <img src="https://latex.codecogs.com/png.latex?R_0"> accounting for network effects</a>.</p>
</section>
</section>
<section id="forecasting-and-nowcasting-infection-dynamics" class="level3">
<h3 class="anchored" data-anchor-id="forecasting-and-nowcasting-infection-dynamics">Forecasting and nowcasting infection dynamics</h3>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>Forecasting and nowcasting of infections are crucial for planning and resource allocation during an outbreak. Forecasting is the prediction of future cases, deaths, or other outcomes, while nowcasting is the prediction of the current outbreak situation. These predictions can help public health authorities to anticipate the trajectory of the outbreak and to implement timely interventions.</p>
</div>
</div>
</div>
<p><a href="https://epiforecasts.io/EpiNow2/"><code>{EpiNow2}</code></a> and <a href="https://package.epinowcast.org/"><code>{epinowcast}</code></a> provide functions to forecast and nowcast the number of cases. The data required for <code>{EpiNow2}</code> has already been described in the previous section. The <code>{epinowcast}</code> package similarly requires data on the number of cases reported per date. <code>{epinowcast}</code> does not currently support forecasting but there are plans to add this functionality in future versions.</p>
</section>
<section id="estimating-disease-severity" class="level3">
<h3 class="anchored" data-anchor-id="estimating-disease-severity">Estimating disease severity</h3>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>The case fatality risk (CFR) is often used to assess the severity of a disease. CFR here refers to the proportion of deaths among confirmed cases.</p>
</div>
</div>
</div>
<p>With incidence data on the number of cases reported and the number of deaths reported, the <a href="https://epiverse-trace.github.io/cfr/"><code>{cfr}</code></a> package can be used to estimate the case fatality rate and its uncertainty. Importantly, it accounts for the delay between the onset of symptoms and death, which is crucial for accurate estimation of the case fatality rate.</p>
<p>Here again, <code>{EpiNow2}</code> can be used to estimate the time-varying case fatality ratio using the same data as for the reproduction number. <code>{EpiNow2}</code> can estimate other severity metrics, such as the case hospitalisation ratio, given data on cases and hospitalisations, and the hospitalisation fatality ratio, if data on hospitalisations and associated deaths are available.</p>
</section>
<section id="assessing-the-impact-of-interventions" class="level3">
<h3 class="anchored" data-anchor-id="assessing-the-impact-of-interventions">Assessing the impact of interventions</h3>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>mpox can be mitigated with behaviour change, treatment, and vaccination. Here, a few tools are available to assess the impact of intervention scenarios.</p>
</div>
</div>
</div>
<p><a href="https://epiverse-trace.github.io/epidemics/"><code>{epidemics}</code></a> provides ready compartmental models to estimate the impact of vaccination and non-pharmaceutical interventions like behaviour change, which can conceptually be modelled as a reduction in the transmission rate through changes in the population contact structure.</p>
<p>If we want to explore population-level outbreak dynamics, <code>{epidemics}</code> allows for stratifying the population into arbitrary groups, specifying the contact structure between these groups, and rates of interventions. The data required to run these models include: population structure, contact structure, and timing and magnitude of interventions. Data on social contact matrices can be obtained from the <a href="https://github.com/epiforecasts/socialmixr"><code>{socialmixr}</code></a> package.</p>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this post, we have outlined common outbreak analytics tasks relevant to the mpox outbreak, the data required, and R packages/tools that are currently available to facilitate these tasks. The tools described here are being developed by the Epiverse-TRACE team and the wider community, with the aim of ensuring high standards of research software development, and validation from end users, including epidemiologists, clinicians, and policy makers. The tools are designed to be user-friendly and well integrated, enabling one analysis task to easily feed into another. We <a href="https://epiverse-trace.github.io/get-involved.html">would therefore be keen to hear</a> from other groups interested in potentially collaborating or contributing on this growing ecosystem of tools.</p>
<p><em>Thanks to Karim Mane (<span class="citation" data-cites="Karim-Mane">(<strong>Karim-Mane?</strong>)</span>) and Chris Hartgerink (<span class="citation" data-cites="chartgerink">(<strong>chartgerink?</strong>)</span>) for their valuable comments on earlier drafts of this post.</em></p>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-charniga2024updating" class="csl-entry">
Charniga, Kelly, Andrea M McCollum, Christine M Hughes, Benjamin Monroe, Joelle Kabamba, Robert Shongo Lushima, Toutou Likafi, et al. 2024. <span>“Updating Reproduction Number Estimates for Mpox in the Democratic Republic of Congo Using Surveillance Data.”</span> <em>The American Journal of Tropical Medicine and Hygiene</em> 110 (3): 561. https://doi.org/<a href="https://doi.org/10.4269/ajtmh.23-0215">https://doi.org/10.4269/ajtmh.23-0215</a>.
</div>
<div id="ref-charniga2024best" class="csl-entry">
Charniga, Kelly, Sang Woo Park, Andrei R Akhmetzhanov, Anne Cori, Jonathan Dushoff, Sebastian Funk, Katelyn M Gostic, et al. 2024. <span>“Best Practices for Estimating and Reporting Epidemiological Delay Distributions of Infectious Diseases Using Public Health Surveillance and Healthcare Data.”</span> <em>arXiv Preprint arXiv:2405.08841</em>. https://doi.org/<a href="
https://doi.org/10.48550/arXiv.2405.08841"> https://doi.org/10.48550/arXiv.2405.08841</a>.
</div>
<div id="ref-gostic2020practical" class="csl-entry">
Katelyn M. Gostic, Edward B. Baskerville, Lauren McGough. 2020. <span>“Practical Considerations for Measuring the Effective Reproductive Number, Rt.”</span> <em>PLoS Computational Biology</em> 16 (12): e1008409. https://doi.org/<a href="https://doi.org/10.1371/journal.pcbi.1008409">https://doi.org/10.1371/journal.pcbi.1008409</a>.
</div>
<div id="ref-laurenson2023description" class="csl-entry">
Laurenson-Schafer, Henry, Nikola Sklenovská, Ana Hoxha, Steven M Kerr, Patricia Ndumbi, Julia Fitzner, Maria Almiron, et al. 2023. <span>“Description of the First Global Outbreak of Mpox: An Analysis of Global Surveillance Data.”</span> <em>The Lancet Global Health</em> 11 (7): e1012–23. https://doi.org/<a href="https://doi.org/10.1016/S2214-109X(23)00198-5">https://doi.org/10.1016/S2214-109X(23)00198-5</a>.
</div>
<div id="ref-park2024estimating" class="csl-entry">
Park, Sang Woo, Andrei R Akhmetzhanov, Kelly Charniga, Anne Cori, Nicholas G Davies, Jonathan Dushoff, Sebastian Funk, et al. 2024. <span>“Estimating Epidemiological Delay Distributions for Infectious Diseases.”</span> <em>medRxiv</em>, 2024–01. https://doi.org/<a href="https://doi.org/10.1101/2024.01.12.24301247">https://doi.org/10.1101/2024.01.12.24301247</a>.
</div>
<div id="ref-ward2022transmission" class="csl-entry">
Ward, Thomas, Rachel Christie, Robert S Paton, Fergus Cumming, and Christopher E Overton. 2022. <span>“Transmission Dynamics of Monkeypox in the United Kingdom: Contact Tracing Study.”</span> <em>Bmj</em> 379. https://doi.org/<a href="http://dx.doi.org/10.1136/ bmj-2022-073153">http://dx.doi.org/10.1136/ bmj-2022-073153</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><a href="https://www.who.int/emergencies/disease-outbreak-news/item/2024-DON522">WHO Disease Outbreak News</a>↩︎</p></li>
<li id="fn2"><p><a href="https://www.cdc.gov/forecast-outbreak-analytics/about/modeling-forecasting/mpox-transmission.html">Modeling Household Transmission of Clade I Mpox in the United States</a>↩︎</p></li>
<li id="fn3"><p><a href="https://www.cdc.gov/forecast-outbreak-analytics/about/modeling-forecasting/mpox-gbmsm-technical-brief.html">Risk of Clade 1 Mpox Outbreaks Among Gay, Bisexual, and Other Men Who Have Sex With Men in the United States</a>↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{azam2024,
  author = {Azam, James and Gruson, Hugo and Kucharski, Adam},
  title = {2024 Mpox Outbreak: Common Analytics Tasks and Available {R}
    Tools},
  date = {2024-01-04},
  url = {https://epiverse-trace.github.io/posts/mpox-preparedness/},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-azam2024" class="csl-entry quarto-appendix-citeas">
Azam, James, Hugo Gruson, and Adam Kucharski. 2024. <span>“2024 Mpox
Outbreak: Common Analytics Tasks and Available R Tools.”</span> January
4, 2024. <a href="https://epiverse-trace.github.io/posts/mpox-preparedness/">https://epiverse-trace.github.io/posts/mpox-preparedness/</a>.
</div></div></section></div> ]]></description>
  <category>Epiverse-TRACE</category>
  <category>mpox</category>
  <category>outbreak</category>
  <category>outbreak-analytics</category>
  <category>DOI</category>
  <guid>https://epiverse-trace.github.io/posts/mpox-preparedness/</guid>
  <pubDate>Thu, 04 Jan 2024 00:00:00 GMT</pubDate>
</item>
</channel>
</rss>
